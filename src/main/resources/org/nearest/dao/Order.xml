<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="org.nearest.dao.OrderDao">
  <resultMap type="order" id="orderMap">
    <id     column="order_no"       property="no" />
    <result column="order_dt"       property="orderDate" />
    <result column="order_st"      property="orderState" />
    <association property="mart" javaType="mart">
      <result column="mt_no" property="no" javaType="INTEGER"/>
    </association>
    <association property="client" javaType="client">
      <result column="clnt_no" property="no" javaType="INTEGER"/>
    </association>
  </resultMap>
  
  <resultMap type="productOrder" id="productOrderMap">
    <result column="order_ent" property="entity"/>
    <collection property="order" column="order_no" ofType="order" javaType="java.util.List">
      <id column="order_no" property="no" javaType="INTEGER"/>
      <result column="order_st" property="orderState" javaType="INTEGER"/>
      <result column="order_dt" property="orderDate" javaType="java.sql.Date"/>
      <collection property="martList" column="mt_no" ofType="mart" javaType="java.util.List">
        <result column="mt_no" property="no" javaType="INTEGER"/>
        <result column="mt_nm" property="name" javaType="string"/>
      </collection>
      <collection property="product" column="prod_no" ofType="product" javaType="java.util.List">
        <id column="prod_no" property="no" javaType="INTEGER"/>
        <result column="prod_nm" property="name" javaType="string"/>
        <result column="prod_pri" property="price" javaType="int"/>
      </collection>
    </collection>
  </resultMap>
  
  
  
  <insert id="insertOrder" parameterType="map">
    insert into 
    orders (order_dt, order_st, mt_no, clnt_no) 
    values 
      <foreach collection="noDuplMartNo" item="item" separator=",">
         ( now(), 1, #{item}, #{clientNo})  
      </foreach>
    <selectKey resultType="int" keyProperty="orderNo" order="AFTER">
      SELECT LAST_INSERT_ID();
    </selectKey>
  </insert>
  
  <select id="selectOrderCount" resultType="java.util.HashMap" parameterType="int">
	  select distinct
			(select count(DISTINCT(order_dt)) from orders where ORDER_ST = 1 and clnt_no = #{value}) as paid,
			(select count(DISTINCT(order_dt)) from orders where ORDER_ST = 2 and clnt_no = #{value}) as preparing,
			(select count(DISTINCT(order_dt)) from orders where ORDER_ST = 3 and clnt_no = #{value}) as complete
		from orders
  </select>
  
  <select id="selectOrderList" resultMap="productOrderMap" parameterType="int">
    select p.prod_no, p.prod_nm, po.order_ent, p.prod_pri, m.mt_nm, o.order_no, o.order_st, o.order_dt
		from marts m, prods p, orders o, prod_orders po
		where o.clnt_no = #{value}
		and p.mt_no = m.mt_no
		and m.mt_no = o.mt_no
		and o.order_no = po.order_no
		and po.prod_no = p.prod_no
  </select>

  

</mapper>